<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–°–∫–∞–Ω–µ—Ä QR-–∫–æ–¥–∞</title>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR-–∫–æ–¥–æ–≤ -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background-color: #f7f8fa;
      color: #2c3e50;
      margin: 0;
    }

    h2 {
      text-align: center;
      color: #34495e;
    }

    #reader {
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      background-color: #fff;
    }

    #result {
      margin-top: 24px;
      padding: 16px;
      background-color: #ecf0f1;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      word-break: break-all;
      font-size: 16px;
      line-height: 1.5;
    }

    #qr-result {
      font-family: monospace;
      color: #2c3e50;
      margin: 8px 0 0;
      font-size: 15px;
    }

    button {
      display: block;
      width: 100%;
      max-width: 400px;
      margin: 20px auto;
      padding: 14px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #start-scan {
      background-color: #3498db;
      color: white;
    }

    #start-scan:hover {
      background-color: #2980b9;
    }

    #start-scan:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }

    #close-app {
      background-color: #95a5a6;
      color: #fff;
      display: none;
    }

    #close-app:hover {
      background-color: #7f8c8d;
    }
  </style>
</head>
<body>
  <h2>üì∑ –°–∫–∞–Ω–µ—Ä QR-–∫–æ–¥–∞</h2>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–∫–∞–Ω–µ—Ä–∞ -->
  <div id="reader"></div>

  <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
  <div id="result" style="display: none;">
    <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong>
    <p id="qr-result"></p>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞/–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞ -->
  <button id="start-scan">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>

  <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è Web App -->
  <button id="close-app">–ó–∞–∫—Ä—ã—Ç—å</button>

  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    const tg = window.Telegram?.WebApp;
    tg.ready();

    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const resultDiv = document.getElementById("result");
    const qrResult = document.getElementById("qr-result");
    const startButton = document.getElementById("start-scan");
    const closeButton = document.getElementById("close-app");

    let html5QrcodeScanner = null;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ó–∞–ø—É—Å—Ç–∏—Ç—å/–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"
    startButton.addEventListener("click", function () {
      if (startButton.textContent.trim() === "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å") {
        stopScanner();
        return;
      }

      // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∞–ø—É—Å–∫—É
      resultDiv.style.display = "none";
      startButton.disabled = true;
      startButton.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";

      // –°–æ–∑–¥–∞—ë–º —Å–∫–∞–Ω–µ—Ä
      html5QrcodeScanner = new Html5Qrcode("reader");

      // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–µ—Ä
      html5QrcodeScanner.start(
        { facingMode: "environment" }, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É
        {
          fps: 10, // –ö–∞–¥—Ä—ã –≤ —Å–µ–∫—É–Ω–¥—É
          qrbox: { width: 280, height: 280 } // –†–∞–∑–º–µ—Ä –æ–±–ª–∞—Å—Ç–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        },
        (decodedText) => {
          // –£—Å–ø–µ—à–Ω–æ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ
          stopScanner();

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          qrResult.textContent = decodedText;
          resultDiv.style.display = "block";
          startButton.textContent = "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä";
          startButton.disabled = false;
          closeButton.style.display = "block";

          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç–∞
          if (tg) {
            tg.sendData(decodedText);
          }
        },
        (errorMessage) => {
          // –û—à–∏–±–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è (–º–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å)
        }
      ).catch((err) => {
        console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞–º–µ—Ä—ã:", err);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É: " + (err.message || err));
        startButton.disabled = false;
        startButton.textContent = "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä";
      });

      startButton.textContent = "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å";
      startButton.disabled = false;
    });

    // –§—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞
    function stopScanner() {
      if (html5QrcodeScanner) {
        html5QrcodeScanner.stop().then(() => {
          html5QrcodeScanner.clear();
          html5QrcodeScanner = null;
        }).catch((err) => {
          console.error("–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞:", err);
        });
      }
    }

    // –ö–Ω–æ–ø–∫–∞ "–ó–∞–∫—Ä—ã—Ç—å" ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ—Ç Web App
    closeButton.addEventListener("click", () => {
      tg.close();
    });
  </script>
</body>
</html>
