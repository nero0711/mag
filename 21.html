<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0;
      background-color: #b3f3f3;
      user-select: none;
      overflow-x: hidden;
      overflow-y: hidden;
      min-height: 100vh;
    }

    :root{
      --ink: #22252b;
      --chassis-top: #f3f3f4;
      --chassis-side: #e6e6e8;
      --accent-blue: #2b5d89;
      --accent-blue-2: #2d6aa0;
      --slot: #ffffff;
      --screen: #3b4a57;
      --screen-gloss: #708090;
      --shadow: rgba(0,0,0,.18);
      --shadow-strong: rgba(0,0,0,.25);
      --btn-red: #e0574c;
      --btn-yellow: #f2cf3e;
      --btn-green: #7fca75;
      --btn-blue: #4aa0d5;
      --btn-grey: #e9eaef;
      --ring: #f9d94d;
    }

    .device{
      position: relative;
      display: flex;
      align-items: center;
      width: 350px;
      height: 490px;
      flex-direction: column;
      background-color: #c4bfb9;
      aspect-ratio: 0.9 / 1;
      border-radius: 40px;
      box-shadow: inset 0px 0px 0px 0px #365a7a,
      0px -5px 0px black,
      -5px -5px 0px black,
      0px 20px 0px #365a7a,
      9px 20px 0px #365a7a,
      0px 40px 0px #2b4b68,
      9px 40px 0px #2b4b68,
      9px 45px 0px black,
      -5px 45px 0px black,
      14px 43px 0px black,
      14px 21px 0px black;
    }

    .panel { position: relative; border-radius: 10px 10px 32px 32px; background-color: #f1f1e9; border: 0px; padding: 17px; display: flex; margin: 0px 23px 35px 23px; width: 270px; height: 440px; }

    .position-items { display: flow; align-items: center; justify-content: space-between; }

    .screen{ display: flex; position: relative; border-radius: 14px; width: 260px; height: 260px; background: var(--screen); border: 3px solid var(--ink); overflow: hidden; margin: 10px 2px 30px 2px; box-shadow: 0px -5px 0px 7px #b1aea7 }
    .screen::after{ content: ""; position: absolute; inset: 0; background: linear-gradient(135deg, transparent 52%, rgba(255, 255, 255, .06) 52.2%, rgba(255, 255, 255, .12) 100%, transparent 71%); mix-blend-mode: screen; pointer-events: none; }

    .controls { position: relative; display: flex; flex-direction: row; gap: 12px; }

    .pad { position: relative; width: 270px; height: 120px; border-radius: 12px; background: #f8f8fa; border: 2.5px solid var(--ink); display: flex;  padding: 5px; box-sizing: border-box; }
    .pad-btn { position: relative;
    width: 150px;
    height: 100px;
    display: grid
;
    grid-template-columns: repeat(3, 50px);
    grid-template-rows: repeat(2, 50px);
    margin: 0px 10px 0px 0px;
    }

    .btn { width: 40px; height: 40px; background-color: var(--control-bg); color: white; font-size: 15px; font-weight: bold; border: 1px solid #4d4d4d; border-radius: 50px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s, opacity 0.2s; }

    .btn:active { transform: translateY(4px); box-shadow: 0px 3px 0px var(--shadow-dark); }

    .input-yellow {
      margin: 5px 5px 5px 40px;
    }
    .input{
      padding: 5px 15px;
      font-size: 18px;
      border: 2px solid #717171;
      border-radius: 10px;
      background-color: #f1f1e9;
      color: #696969;
      box-shadow: inset 2px 2px 0px 2px #b2aea7, 0px 3px 0px #c4bfb9;
      outline: none;
      text-align: center;
      font-weight: bold;
      height: 15px;
      width: 20px;
    }

    .btn-joystick { width: 60px; height: 50px; margin: 0px 3px 3px 3px; }
    .btn-red { grid-column: 3; grid-row: 1; background-color: #F16760; box-shadow: 0px 4px 0px #BB524A, 3px 4px 0px #BB524A; border: solid 1px #BB524A; font-size: 30px; }
    .btn-red_on_off { background-color: #F16760; box-shadow: 1px -4px 0px #BB524A, -1px -4px 0px #BB524A; border: solid 1px #BB524A; width: 20px; margin: 10px 0px 0px 0px; height: 20px; }
    .btn-red_on_off:active { transform: translateY(-4px); }
    .btn-green1 { width: 40px; grid-column: 2; grid-row: 1; background-color: #7DD879; box-shadow: 0px 4px 0px #6BBB63, 3px 4px 0px #6BBB63; border: solid 1px #6BBB63; position: relative;  }
    .btn-blue1 { width: 40px; grid-column: 1; grid-row: 1; background-color: #578CF8; box-shadow: 0px 4px 0px #4369B6, 3px 4px 0px #4369B6; border: solid 1px #4369B6; }

    /* ===== Джойстик ===== */
    .joystick{
      justify-self: center;
      width: 70px;
      aspect-ratio: 1/1;
      position: relative;
      border-radius: 50%;
      background: var(--ring);
      border: 3px solid var(--ink);
      box-shadow: inset 0 0 0 8px rgba(0,0,0,.06);
      display: grid;
      place-items: center;
      margin: auto;
    }
    .joystick .inner{
      width: 44px;
      aspect-ratio: 1/1;
      border-radius: 50%;
      background: var(--accent-blue);
      border: 3px solid var(--ink);
      display: grid;
      place-items: center;
      position: relative;
    }
    .crosshair{
      width: 30px;
      height: 30px;
      border: 3px solid var(--ink);
      border-radius: 50%;
      background: radial-gradient(circle at center, rgba(255,255,255,.08), transparent 60%);
      position: relative;
      transition: transform 0.1s ease-out;
    }
    .crosshair::before,
    .crosshair::after{
      content: "";
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: var(--ink);
    }
    .crosshair::before{ width: 2px; height: 20px; }
    .crosshair::after{ height: 2px; width: 20px; }

    /* Анимация крестовины при нажатии */
    .crosshair.moved {
      transition: transform 0.1s ease-out;
    }
    .crosshair.moved-up    { transform: translateY(-6px); }
    .crosshair.moved-down  { transform: translateY(6px); }
    .crosshair.moved-left  { transform: translateX(-6px); }
    .crosshair.moved-right { transform: translateX(6px); }

    .vents{ justify-self: end; display: grid; grid-auto-flow: column; gap: 8px; padding-right: 6px; }
    .vents span{ width: 6px; height: 28px; background: var(--ink); border-radius: 3px; opacity: .28; }

    .down-blue{ display: flex; width: 200px; height: 25px; margin: 4px 29px -10px 29px; border-bottom: 25px solid #365a7a; border-left: 20px solid transparent; border-right: 20px solid transparent; }
    .joystick-container {
      position: relative;
      width: 90px;
      height: 90px;
      margin: 6px 0px 10px 0px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .joystick-zone {
      position: absolute;
      cursor: pointer;
      z-index: 2;
      transition: opacity 0.2s;
    }

    .joystick-zone.disabled {
      opacity: 0.4;
      cursor: default;
    }

    .title_dev { font-size: 12px; font-weight: 700; margin: 17px 0px 10px 40px; justify-content: center; display: flex; color: #365a7a; z-index: 20;left:64%; transform: translateX(-50%); width:auto; top: -3%; position: absolute; }
    .buttom-panel { display: flex; justify-content: space-around; }

    .grid {
      width: 100%;
      height: 100%;
      display: none;
      gap: 1px;
      background-color: #555;
      box-sizing: border-box;
      touch-action: none;
      cursor: crosshair;
      position: relative;
    }

    .cell {
      background-color: #ccc;
      transition: background-color 0.12s;
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      position: relative;
    }

    .cell.black { background-color: #000; }

    .cell.temp-black { background-color: rgba(0,0,0,0.6); }

    .grid.no-grid-lines { gap: 0; background-color: transparent; }

    .help-overlay, .confirm-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }

    .help-content, .confirm-content {
      background: #222;
      padding: 20px;
      border-radius: 10px;
      color: #fff;
      text-align: center;
      max-width: 80%;
    }

    .confirm-content {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .confirm-buttons {
      display: flex;
      justify-content: space-around;
    }

    .confirm-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .confirm-btn.yes {
      background-color: #e0574c;
      color: white;
    }

    .confirm-btn.no {
      background-color: #7fca75;
      color: white;
    }

    .line-length-label {
      position: absolute;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      pointer-events: none;
      z-index: 5;
      display: none;
    }

    .cursor {
      position: absolute;
      width: 1px;
      height: 1px;
      background: transparent;
      border: 2px solid #e0574c;
      border-radius: 50%;
      pointer-events: none;
      z-index: 30;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 6px rgba(224,87,76,0.8);
      display: none;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 0.8; }
      50% { opacity: 1; }
      100% { opacity: 0.8; }
    }

    .toggle-container {
      grid-column: 1;
      grid-row: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .toggle-label {
      font-size: 10px;
      text-align: center;
      margin-top: 5px;
      color: #333;
    }

    #resizeConfirmOverlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }

    #resizeConfirmContent {
      background: #222;
      padding: 20px;
      border-radius: 10px;
      color: #fff;
      text-align: center;
      max-width: 80%;
    }

    #resizeConfirmButtons {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
    }

    #resizeConfirmYes, #resizeConfirmNo {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    #resizeConfirmYes {
      background-color: #e0574c;
      color: white;
    }

    #resizeConfirmNo {
      background-color: #7fca75;
      color: white;
    }

    p.actionCells {
        box-shadow: 0px 0px 9px #d93838;
        border: 2px solid #a34242;
        position: absolute;
        width: 6px;
        height: 6px;
        z-index: 99;
        margin: 0px;
    }
        .crosshair-mini { width: 10px; height: 12px; border-color: var(--ink); border-right-style: solid; border-right-width: 3px; border-left-style: solid; border-left-width: 3px; border-bottom-style: solid; border-bottom-width: 3px; border-radius: 50%; background: radial-gradient(circle at center, rgba(255,255,255,.08), transparent 60%); position: relative; }
    .crosshair-mini::before, .crosshair-mini::after{ content: ""; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); background: var(--ink); } .crosshair-mini::before{ width: 3px; height: 8px; top: 4px }
  </style>
</head>
<body>
<section class="device" role="img" aria-label="Панель устройства с экраном и кнопками">
  <div class="title_dev"> Module06091</div>
  <div class="panel">
    <div class="position-items">
      <div class="screen" aria-hidden="true">
        <div class="grid" id="grid"></div>
        <div class="cursor" id="cursor"></div>
        <div class="line-length-label" id="lineLengthLabel"></div>
        <div class="help-overlay" id="helpOverlay">
          <div class="help-content">
            это блять подсказка, хули тут смотреть
          </div>
        </div>
        <div class="confirm-overlay" id="confirmOverlay">
          <div class="confirm-content">
            <div>Очистить сетку?</div>
            <div class="confirm-buttons">
              <button class="confirm-btn no" id="confirmYes">Да</button>
              <button class="confirm-btn yes " id="confirmNo">Нет</button>
            </div>
          </div>
        </div>
      </div>
      <div class="controls">

        <div class="pad" aria-hidden="true">
          <div class="pad-btn">
            <div class="btn btn-blue1" id="toggleGrid">Hide</div>
            <div class="toggle-container">
              <div class="btn btn-red" id="toggleSwitch">✎</div>
              <div class="toggle-label"></div>
            </div>
            <div class="btn btn-green1" id="helpBtn">help</div>
            <div class="btn btn-red" id="resetGrid">⟳</div>
          </div>

          <!-- Джойстик вместо стрелок -->
          <div class="joystick-container">
            <div class="joystick" aria-label="Джойстик навигации">
              <div class="inner">
                <div class="crosshair" id="joystick-crosshair"></div>
              </div>
            </div>
            <!-- Невидимые зоны для кликов -->
            <div class="joystick-zone" data-dir="up"    style="top: 0; left: 50%; width: 40px; height: 30px; transform: translateX(-50%);"></div>
            <div class="joystick-zone" data-dir="down"  style="bottom: 0; left: 50%; width: 40px; height: 30px; transform: translateX(-50%);"></div>
            <div class="joystick-zone" data-dir="left"  style="top: 50%; left: 0; width: 30px; height: 40px; transform: translateY(-50%);"></div>
            <div class="joystick-zone" data-dir="right" style="top: 50%; right: 0; width: 30px; height: 40px; transform: translateY(-50%);"></div>
          </div>

        </div>


      </div>
      <div class="down-blue"></div>
      <div class="buttom-panel">
        <div class="btn btn-red_on_off" id="toggle-bth">
          <div class="crosshair-mini"></div>
        </div>
        <div class="vents">
          <span></span><span></span><span></span><span></span><span></span>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
const grid = document.getElementById('grid');
const toggleButton = document.getElementById('toggleGrid');
const resetButton = document.getElementById('resetGrid');
const toggleButtonScreen = document.getElementById('toggle-bth');
const helpBtn = document.getElementById('helpBtn');
const toggleSwitch = document.getElementById('toggleSwitch');
const cursor = document.getElementById('cursor');
const lineLengthLabel = document.getElementById('lineLengthLabel');
const helpOverlay = document.getElementById('helpOverlay');
const confirmOverlay = document.getElementById('confirmOverlay');
const confirmYes = document.getElementById('confirmYes');
const confirmNo = document.getElementById('confirmNo');
const joystickCrosshair = document.getElementById('joystick-crosshair');

let COLS = 25;
let ROWS = 25;
let cells = [];
let lastPointerClient = { clientX: 0, clientY: 0 };
let paintMode = false;
let idA = {last: 0 , next: 0};

// Спрятать курсор
function hideCursor() {
  cursor.style.display = 'none';
}

// Обновить положение курсора
function updateCursor(clientX, clientY) {
  const rect = grid.getBoundingClientRect();
  // Ограничиваем курсор внутри сетки
  const boundedX = Math.max(rect.left, Math.min(rect.right, clientX));
  const boundedY = Math.max(rect.top, Math.min(rect.bottom, clientY));
  cursor.style.left = boundedX + 'px';
  cursor.style.top = boundedY + 'px';
  cursor.style.display = 'block';
  lastPointerClient = { clientX: boundedX, clientY: boundedY };
}

// Получить ячейку под курсором
function getCellUnderClientXY(clientX, clientY) {
  const rect = grid.getBoundingClientRect();
  const style = getComputedStyle(grid);
  const padLeft = parseFloat(style.paddingLeft) || 0;
  const padTop = parseFloat(style.paddingTop) || 0;
  const padRight = parseFloat(style.paddingRight) || 0;
  const padBottom = parseFloat(style.paddingBottom) || 0;
  const gap = parseFloat(style.gap) || 0;
  const innerWidth = rect.width - padLeft - padRight;
  const innerHeight = rect.height - padTop - padBottom;
  if (innerWidth <= 0 || innerHeight <= 0) return null;
  const cellW = (innerWidth - (COLS - 1) * gap) / COLS;
  const cellH = (innerHeight - (ROWS - 1) * gap) / ROWS;
  const x = clientX - rect.left - padLeft;
  const y = clientY - rect.top - padTop;
  if (x < -1 || y < -1 || x > innerWidth + 1 || y > innerHeight + 1) return null;
  let col = Math.floor(x / (cellW + gap));
  let row = Math.floor(y / (cellH + gap));
  col = Math.max(0, Math.min(COLS - 1, col));
  row = Math.max(0, Math.min(ROWS - 1, row));
  return { row, col };
}

function coordToIndex(row, col) {
  return row * COLS + col;
}

function createGrid(cols, rows) {
  grid.innerHTML = '';
  cells = [];
  grid.style.setProperty('grid-template-columns', `repeat(${cols}, 1fr)`);
  grid.style.setProperty('grid-template-rows', `repeat(${rows}, 1fr)`);
  for (let i = 0; i < rows * cols; i++) {
    const cell = document.createElement('div');
    cell.classList.add('cell');
    cells.push(cell);
    grid.appendChild(cell);
  }
}

// Функция для установки цвета ячейки в зависимости от состояния переключателя
function updateCellColorUnderCursor() {
  const pos = getCellUnderClientXY(lastPointerClient.clientX, lastPointerClient.clientY);
  if (!pos) return;
  const idx = coordToIndex(pos.row, pos.col);
  if (cells[idx]) {
    if (paintMode) {
      cells[idx].classList.add('black');
    } else {
      cells[idx].classList.remove('black');
    }
  }
}

// Функция движения джойстика
function moveJoystick(dx, dy) {
  updateCursor(lastPointerClient.clientX + dx, lastPointerClient.clientY + dy);
  updateCellColorUnderCursor();
}

// Универсальный обработчик для джойстика
function handleArrowClick(dx, dy) {
  moveJoystick(dx, dy);
  idA.last = idA.next;
  const pos = getCellUnderClientXY(lastPointerClient.clientX, lastPointerClient.clientY);
  if (pos) {
    const id = coordToIndex(pos.row, pos.col);
    idA.next = id;

    if (idA.last !== idA.next && cells[idA.last]) {
      cells[idA.last].innerHTML = '';
    }
    if (cells[idA.next]) {
      cells[idA.next].innerHTML = '<p class="actionCells"></p>';
    }
  }
}

// Обработчик кликов по зонам джойстика
function handleJoystickClick(direction) {
  let dx = 0, dy = 0;
  let moveClass = '';

  switch(direction) {
    case 'up':    dy = -10; moveClass = 'moved-up'; break;
    case 'down':  dy = 10;  moveClass = 'moved-down'; break;
    case 'left':  dx = -10; moveClass = 'moved-left'; break;
    case 'right': dx = 10;  moveClass = 'moved-right'; break;
  }

  // Анимация крестовины
  joystickCrosshair.classList.add('moved', moveClass);
  setTimeout(() => {
    joystickCrosshair.classList.remove('moved', moveClass);
  }, 150);

  // Вызов существующей логики движения
  handleArrowClick(dx, dy);
}

// Назначаем обработчики на зоны джойстика
document.querySelectorAll('.joystick-zone').forEach(zone => {
  const dir = zone.dataset.dir;
  zone.addEventListener('click', () => handleJoystickClick(dir));
  // Для тач-устройств
  zone.addEventListener('touchstart', (e) => {
    e.preventDefault();
    handleJoystickClick(dir);
  });
});

// Управление кнопками
toggleButton.addEventListener('click', () => {
  const currentlyNoLines = grid.classList.toggle('no-grid-lines');
  toggleButton.textContent = currentlyNoLines ? 'Show' : 'Hide';
});

resetButton.addEventListener('click', () => {
  confirmOverlay.style.display = 'flex';
});

confirmYes.addEventListener('click', () => {
  document.querySelectorAll('.cell').forEach(cell => {
    cell.classList.remove('black', 'temp-black');
    cell.innerHTML = '';
  });
  if (cells.length > 0) {
    cells[0].innerHTML = '<p class="actionCells"></p>';
    idA.next = 0;
    idA.last = 0;
  }
  confirmOverlay.style.display = 'none';
});

confirmNo.addEventListener('click', () => {
  confirmOverlay.style.display = 'none';
});

helpBtn.addEventListener('click', () => {
  helpOverlay.style.display = helpOverlay.style.display === "flex" ? "none" : "flex";
});

helpOverlay.addEventListener('click', (e) => {
  if (e.target === helpOverlay) helpOverlay.style.display = "none";
});

confirmOverlay.addEventListener('click', (e) => {
  if (e.target === confirmOverlay) confirmOverlay.style.display = "none";
});

let isPainting = false;

function startPainting() {
  if (isPainting) return; // защита от повторного вызова
  isPainting = true;
  paintMode = true;
  // Визуальное нажатие кнопки
  toggleSwitch.style.transform = 'translateY(4px)';
  toggleSwitch.style.boxShadow = '0px 0px 0px var(--shadow-dark)';
  updateCellColorUnderCursor();
}

function stopPainting() {
  if (!isPainting) return;
  isPainting = false;
  paintMode = false;
  // Возврат кнопки в исходное состояние
  toggleSwitch.style.transform = '';
  toggleSwitch.style.boxShadow = '';
  updateCellColorUnderCursor();
}

// Для мыши
toggleSwitch.addEventListener('mousedown', (e) => {
  e.preventDefault();
  startPainting();
});

toggleSwitch.addEventListener('mouseup', () => {
  stopPainting();
});

toggleSwitch.addEventListener('mouseleave', () => {
  if (isPainting) stopPainting();
});

// Для тач-устройств
toggleSwitch.addEventListener('touchstart', (e) => {
  e.preventDefault();
  startPainting();
});

toggleSwitch.addEventListener('touchend', () => {
  stopPainting();
});

// Обработчики клавиатуры
document.addEventListener('keydown', (e) => {
  if (e.code === 'Space' && !isPainting) {
    e.preventDefault(); // отключаем скролл пробелом
    startPainting();
  }
});

document.addEventListener('keyup', (e) => {
  if (e.code === 'Space' && isPainting) {
    e.preventDefault();
    stopPainting();
  }
});


document.addEventListener('keydown', (e) => {
  switch (e.code) {
    case 'ArrowUp':
      e.preventDefault();
      handleJoystickClick('up');
      break;
    case 'ArrowDown':
      e.preventDefault();
      handleJoystickClick('down');
      break;
    case 'ArrowLeft':
      e.preventDefault();
      handleJoystickClick('left');
      break;
    case 'ArrowRight':
      e.preventDefault();
      handleJoystickClick('right');
      break;
  }
});

function getCellSize() {
  const rect = grid.getBoundingClientRect();
  const style = getComputedStyle(grid);
  const padLeft = parseFloat(style.paddingLeft) || 0;
  const padTop = parseFloat(style.paddingTop) || 0;
  const gap = parseFloat(style.gap) || 0;
  const cellW = (rect.width - padLeft - parseFloat(style.paddingRight) - (COLS - 1) * gap) / COLS;
  const cellH = (rect.height - padTop - parseFloat(style.paddingBottom) - (ROWS - 1) * gap) / ROWS;
  return { cellW, cellH };
}

function updateCursorSize() {
  const { cellW, cellH } = getCellSize();
  const size = Math.min(cellW, cellH) * 0.8;
  cursor.style.width = size + "px";
  cursor.style.height = size + "px";
}

// Функция управления активностью кнопок
function setButtonsEnabled(enabled) {
  const buttons = [
    toggleButton,
    resetButton,
    toggleSwitch,
    helpBtn
  ];

  buttons.forEach(btn => {
    if (btn) {
      btn.disabled = !enabled;
      if (btn.classList && btn.classList.contains('btn')) {
        btn.style.opacity = enabled ? 1 : 0.5;
      }
    }
  });

  // Для зон джойстика — управляем через класс и pointer-events
  document.querySelectorAll('.joystick-zone').forEach(zone => {
    if (enabled) {
      zone.classList.remove('disabled');
      zone.style.pointerEvents = 'auto';
    } else {
      zone.classList.add('disabled');
      zone.style.pointerEvents = 'none';
    }
  });
}

// Инициализация
createGrid(COLS, ROWS);
updateCursorSize();

// Установим курсор в левый верхний угол сетки при загрузке
setTimeout(() => {
  const rect = grid.getBoundingClientRect();
  const style = getComputedStyle(grid);
  const padLeft = parseFloat(style.paddingLeft) || 0;
  const padTop = parseFloat(style.paddingTop) || 0;
  const gap = parseFloat(style.gap) || 0;
  const cellW = ((rect.width - padLeft - parseFloat(style.paddingRight)) - (COLS - 1) * gap) / COLS;
  const cellH = ((rect.height - padTop - parseFloat(style.paddingBottom)) - (ROWS - 1) * gap) / ROWS;

  const x = rect.left + padLeft + cellW / 2;
  const y = rect.top + padTop + cellH / 2;

  lastPointerClient = { clientX: x, clientY: y };
  updateCursor(x, y);

  // Поставим индикатор на первую ячейку
  if (cells.length > 0) {
    cells[0].innerHTML = '<p class="actionCells"></p>';
    idA.next = 0;
    idA.last = 0;
  }
}, 100);

// --- НОВОЕ: Изначально отключаем все кнопки ---
setButtonsEnabled(false);

// Обработчик кнопки включения/выключения
toggleButtonScreen.addEventListener('click', () => {
  const currentDisplay = window.getComputedStyle(grid).display;
  const isTurningOn = currentDisplay === "none";

  grid.style.display = isTurningOn ? "grid" : "none";

  if (isTurningOn) {
    setButtonsEnabled(true);
    updateCursor(lastPointerClient.clientX, lastPointerClient.clientY);
    if (cells.length > 0) {
      cells[0].innerHTML = '<p class="actionCells"></p>';
    }
  } else {
    setButtonsEnabled(false);
    hideCursor();
    if (cells.length > 0) {
      const lightStart = document.createElement('p');
      lightStart.classList.add('actionCells');
      cells[0].append(lightStart);
    }
  }
});
</script>
</body>
</html>
